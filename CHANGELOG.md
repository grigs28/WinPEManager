u# 变更日志 (CHANGELOG)

本文档记录了WinPE制作管理器的所有重要变更。

版本号遵循 [语义化版本](https://semver.org/lang/zh-CN/) 规范。

---

## [0.1.5] - 2025-10-26

### 🚀 新增
- **WIM挂载路径映射优化**：完善递归扫描WIM文件的路径映射逻辑
  - 新增`scan_wim_files_in_build_dir()`方法，优先扫描标准WinPE构建目录
  - 支持指定WIM文件路径挂载，不再局限于默认boot.wim文件
  - 改进MountThread类，增加wim_file_path参数支持任意WIM文件挂载

### 🔧 改进
- **列表显示优化**：
  - 显示WIM文件的相对路径，提高文件位置识别准确性
  - 优化工具提示信息，包含完整路径、相对路径、大小等详细信息
  - 已挂载项文件名前添加📂图标，提高视觉识别度
- **样式系统优化**：
  - 已挂载项使用浅绿色背景#E8F5E8和深绿色文字#2E7D32
  - 改进列表悬停效果和选中状态的视觉反馈
  - 添加交替背景色和圆角边框，提升界面美观度
- **路径映射算法**：
  - 修复非标准路径格式的构建目录查找逻辑
  - 增强find_build_dir_for_wim方法，支持更多路径格式
  - 优化不同类型WIM文件的大小检查阈值

### 🐛 修复
- **QListWidgetItem.setProperty错误**：修复Qt API调用错误
  - 移除不存在的setProperty方法调用，改用setData方法
  - 简化样式表实现，使用直接颜色设置替代CSS选择器
  - 双重保险确保样式正确应用
- **挂载路径错误**：修复递归扫描WIM文件的挂载卸载路径问题
  - 挂载操作现在使用列表框中选中的实际WIM文件路径
  - 正确处理任意位置扫描到的WIM文件，不局限于标准目录结构
  - 统一挂载管理器接口，支持指定WIM文件路径参数

### 📚 文档
- **CLAUDE.md创建**：建立AI助手代码库指南文档
  - 详细记录项目架构、开发工作流、配置系统
  - 提供完整的命令参考和技术栈说明
  - 包含文件结构总结和重要注意事项

---

## [0.1.4] - 2025-10-26

### 🚀 新增
- **WIM管理功能完全重构**：实现现代化的WIM映像管理界面
  - 取消下拉选择框，简化界面布局和操作流程
  - 递归扫描WinPE工作目录中的所有目录，自动发现所有WIM文件
  - 统一列表显示所有WIM文件，支持完整信息展示和状态可视化
  - 智能识别WIM文件类型（COPYPE/DISM/unknown）和构建目录查找

### 🔧 改进
- **递归扫描系统**：
  - 使用`Path.rglob`进行高效的深度递归遍历
  - 智能WIM文件类型识别和构建目录查找算法
  - 实时挂载状态检查和完整的文件信息展示
  - 标准化的WIM文件数据结构，包含路径、类型、大小、状态等信息
- **进度条优化**：
  - 实现7阶段分进度更新机制，提供准确的进度反馈
  - 挂载操作：5%→15%→25%→35%→45%→85%→95%→100%
  - 卸载操作：5%→15%→25%→35%→45%→85%→95%→100%
  - 智能状态检查和双重验证机制（命令结果+文件系统验证）
- **目录使用逻辑统一**：
  - 所有操作（挂载、卸载、双击）统一使用列表框中的构建目录
  - 移除复杂的路径推断逻辑，使用扫描时确定的正确构建目录
  - 预计算目录信息，避免重复计算，提高操作效率

### 🐛 修复
- **get_logger导入错误**：修复MountThread和UnmountThread中缺少logger导入的问题
  - 在线程开始时正确导入`from utils.logger import get_logger`
  - 确保所有日志记录功能正常工作
- **目录路径错误**：修复挂载和卸载操作使用错误目录的问题
  - 统一使用`wim_file["build_dir"]`而不是路径推断
  - 确保所有操作使用正确的构建目录路径
- **进度条不准确**：修复挂载和卸载进度条跳跃和不准确的问题
  - 分阶段进度更新，每个阶段都有明确的进度指示
  - 添加操作验证和早期退出机制

### 📚 文档
- **WIM管理重构文档**：详细记录界面重构和技术实现
  - 取消下拉选择框的设计思路和实现方案
  - 递归扫描算法和智能文件识别机制
  - 进度条优化和目录使用逻辑的完整说明

### ⚡ 性能
- **扫描性能优化**：使用高效的`Path.rglob`递归遍历算法
- **操作响应速度**：预计算构建目录，避免重复路径分析
- **内存使用优化**：标准化的数据结构，减少内存占用
- **进度响应优化**：减少延迟时间，提供更流畅的用户体验

### 🛡️ 安全
- **权限检查增强**：改进挂载和卸载操作的管理员权限检查
- **路径验证**：添加文件路径安全检查和验证机制
- **错误处理**：完善的异常捕获和用户友好的错误提示
- **操作验证**：双重验证机制确保操作结果的真实性

---

## [0.1.3] - 2025-10-26

### 🚀 新增
- **WinPE启动配置完全重构**：实现完全隐藏cmd.exe窗口的启动方案
  - 基于WinXShell文档研究，优化启动参数和配置
  - 支持无桌面、Cairo Desktop、WinXShell三种启动模式
  - 添加完整的多语言环境变量设置（LANG、LANGUAGE、LC_ALL）
  - 实现静默失败机制，启动失败时不显示cmd.exe

### 🔧 改进
- **WinXShell启动优化**：
  - 使用正确的命令行参数：`-winpe -desktop -silent -jcfg`
  - 添加语言环境变量自动配置
  - 优化启动脚本，完全去掉cmd.exe调用
  - 改进错误处理和调试日志记录
- **多语言支持增强**：
  - 支持10种语言的完整本地化配置
  - 自动字体和字号设置（Microsoft YaHei UI）
  - 语言名称映射和区域设置
- **启动脚本优化**：
  - 所有启动脚本都以`exit`结束，避免残留窗口
  - 智能检测桌面环境运行状态
  - 详细的启动状态反馈和错误诊断

### 🐛 修复
- **MountManager初始化错误**：修复缺少adk_manager参数的问题
  - 修复build_managers.py中MountManager初始化参数不匹配
  - 确保所有管理器类正确传递依赖参数
- **ISO制作双重media目录问题**：
  - 修复copype模式下路径传递错误
  - 错误路径：`D:\...\media\media` → 正确路径：`D:\...\media`
  - 改进路径处理逻辑，避免重复添加media路径
- **启动配置路径问题**：
  - 修正ISO创建器期望的源目录格式
  - 添加详细的路径验证和日志记录

### 📚 文档
- **WinXShell文档研究**：深入分析Desktop\WinXShell\Docs文档
  - 研究WinXShell命令行参数和配置选项
  - 分析JS_DESKTOP、JS_THEMES、JS_TASKBAR等配置段
  - 创建WinXShell配置指南和研究总结文档
- **启动配置文档**：创建详细的WinPE启动配置实现说明
  - 记录cmd.exe窗口隐藏的多种方案
  - 提供完整的配置示例和故障排除指南

### ⚡ 性能
- **启动速度优化**：减少启动时的等待时间
- **内存使用优化**：WinXShell配置优化内存占用限制
- **资源清理**：改进启动失败时的资源清理机制

### 🛡️ 安全
- **权限检查增强**：改进管理员权限检查和重新启动流程
- **路径验证**：添加文件路径安全检查
- **错误处理**：完善的异常捕获和用户友好的错误提示

---

## [0.1.2] - 2025-10-26

### 新增
- **桌面环境配置对话框**：创建完整的桌面环境配置模块`ui/desktop_config_dialog.py`
  - 基本配置标签页：桌面类型选择、程序路径、目录路径配置
  - 高级配置标签页：性能配置、外观配置、自定义参数设置
  - 下载标签页：Cairo Desktop和WinXShell下载链接和说明
  - 帮助标签页：桌面环境使用指南和故障排除
- **直接制作ISO功能**：在开始构建页面添加"制作ISO"按钮
  - 支持copype和传统DISM两种构建模式
  - 用户可选择已构建目录进行ISO制作
  - 详细的制作过程日志输出和进度显示
- **WinXShell语言支持**：WinXShell启动后自动按照基本配置中的语言设置
  - 支持60+种语言的名称映射
  - 自动配置字体、字号等显示设置
  - 完整的语言配置段生成

### 改进
- **桌面环境管理优化**：
  - 取消自动下载功能，改为手动下载提醒
  - 下载地址和配置按钮重新布局，放在桌面环境选择框后面
  - 移除自动下载选项复选框，简化界面
  - 制作ISO时直接生成桌面环境文件，不修改Desktop目录
- **直接制作ISO流程优化**：
  - 要求用户先选定构建目录，不再自动选择最新目录
  - 未选择时弹出友好提示对话框
  - 完整的执行过程日志输出，包含权限检查、配置读取、目录验证等
  - 支持copype和DISM两种模式的详细流程日志
- **用户体验提升**：
  - 下载链接支持点击直接访问
  - 详细的桌面环境状态显示
  - 配置验证和测试功能
  - 完善的错误处理和用户提示

### 修复
- **变量名错误**：修复直接制作ISO中`latest_build`变量名问题
- **UI布局问题**：优化桌面环境配置区域的布局顺序
- **日志输出**：完善直接制作ISO过程的详细日志记录
- **权限检查**：改进管理员权限检查和重新启动流程

### 技术细节
- **模块化设计**：桌面配置功能独立为单独模块
- **配置管理**：完整的桌面环境配置保存和加载机制
- **国际化支持**：WinXShell完整的多语言配置支持
- **错误处理**：完善的异常捕获和用户友好的错误提示

---

## [0.1.1] - 2025-10-25

### 改进
- 优化基本配置标签页布局，提升用户体验
- 去除冗余的表单标签文字，简化界面显示
- 重新设计控件布局，实现更合理的空间分配
- 架构和版本控件现在各占50%宽度，充分利用水平空间
- 语言和构建方式控件各占50%宽度，保持界面平衡
- WinPE专用设置中的三个控件（启用配置、暂存空间、目标路径）现在在同一行，各占33%宽度

### 修复
- 修复界面布局不够紧凑的问题
- 优化控件间距和对齐方式
- 简化"构建方式"标签为"方式"，减少文字冗余

---

## [0.1.0] - 2025-10-25

### 新增
- 主窗口模块化重构，将2344行单一文件拆分为多个功能模块
- 创建ui/main_window/目录，包含UI创建、事件处理、构建管理、日志管理和辅助方法
- 创建ui/build/目录，包含WinPE构建线程处理
- 为每个模块包添加完整的__init__.py文件，提供清晰的模块导出
- 添加ui/README.md文档，详细说明新的目录结构和模块职责

### 改进
- 代码可维护性大幅提升，每个模块专注于特定功能
- 提高代码可扩展性，新功能可轻松添加到相应模块
- 增强代码复用性，模块化代码更容易在其他地方复用
- 改善团队协作效率，不同开发者可专注于不同模块
- 统一导入语句，使用更简洁的模块导入方式

### 修复
- 解决单一文件过大导致的维护困难问题
- 修复模块间依赖关系不清晰的问题
- 统一代码风格和命名规范

---

## [0.0.3] - 2025-10-25

### 改进
- 优化基本配置标签页界面布局
- 调整浏览按钮位置，使其直接跟在文本框后面
- 将5个主要功能按钮（刷新状态、测试DISM工具、关于程序、更新日志、保存基本配置）统一排列在底部
- 使用水平布局实现文本框和浏览按钮的并排显示
- 添加弹性空间确保按钮始终显示在页面底部
- 修复布局警告，确保界面稳定运行

### 修复
- 修复了QLayout重复添加父组件的警告问题
- 优化了按钮宽度设置，保持界面一致性

---

## [0.0.2] - 2025-10-25

### 新增
- 完善日志模块，实现系统日志和构建日志支持
- 新增系统日志处理器，支持写入Windows事件日志
- 新增构建日志专用处理器，为ISO构建过程提供专门日志
- 增强现有日志模块，支持多处理器和上下文感知
- 更新ISO创建模块，添加详细的构建步骤记录
- 更新WinPE构建器，实现完整的构建流程跟踪
- 集成主程序，启用所有日志处理器
- 支持构建会话管理，自动记录开始和结束
- 提供容错机制，系统日志不可用时自动回退

### 改进
- 所有操作同时输出到系统日志和构建日志
- 构建ISO时提供详细的步骤跟踪和错误分析
- 日志系统具备完整的容错和回退机制
- 保持向后兼容性，原有代码无需修改

### 修复
- 修复了日志输出不完整的问题
- 统一了日志格式和编码处理

---

## [未发布]

### 新增
- WinPE构建器模块化重构
- 按功能拆分winpe_builder.py到相应目录
- 创建独立的模块管理器

### 改进
- 代码结构更加模块化和可维护
- 提高了代码的可测试性和可扩展性
- 统一了按钮样式，降低颜色纯度
- 优化了按钮高度，使界面更紧凑

### 修复
- 修复了按钮颜色过于鲜艳的问题
- 统一了所有按钮的视觉风格

---

## [0.0.1] - 2024-01-01

### 新增
- WinPE制作管理器初始版本
- 基础WinPE构建功能
- ADK环境检测和管理
- 图形用户界面

### 改进
- 用户友好的界面设计
- 详细的构建日志

### 修复
- 环境检测问题
- 构建流程优化

---

## 版本说明

### 版本号格式
- **主版本号**: 不兼容的API修改
- **次版本号**: 向下兼容的功能性新增
- **修订号**: 向下兼容的问题修正

### 变更类型
- **新增**: 全新功能
- **改进**: 现有功能的优化
- **修复**: 错误修复
- **删除**: 功能移除
- **安全**: 安全相关的修复

### 发布周期
- **主版本**: 根据需要发布
- **次版本**: 每月发布
- **修订版本**: 根据需要发布

---

*最后更新: 2025-10-26*
