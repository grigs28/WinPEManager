#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ç»Ÿä¸€WIMç®¡ç†å™¨ä¸»ç±»
æ•´åˆæ‰€æœ‰å­æ¨¡å—ï¼Œæä¾›ç»Ÿä¸€çš„WIMç®¡ç†æ¥å£
"""

from pathlib import Path
from typing import Tuple, Dict, Optional

from utils.logger import get_logger, update_log_context

from .path_manager import PathManager
from .check_manager import CheckManager
from .operation_manager import OperationManager
from .status_manager import StatusManager


class UnifiedWIMManager:
    """ç»Ÿä¸€çš„WIMç®¡ç†å™¨ä¸»ç±»
    
    æ•´åˆæ‰€æœ‰å­æ¨¡å—åŠŸèƒ½ï¼Œæä¾›å®Œæ•´çš„WIMç®¡ç†è§£å†³æ–¹æ¡ˆ
    """
    
    def __init__(self, config_manager, adk_manager, parent_callback=None):
        """åˆå§‹åŒ–ç»Ÿä¸€WIMç®¡ç†å™¨
        
        Args:
            config_manager: é…ç½®ç®¡ç†å™¨
            adk_manager: ADKç®¡ç†å™¨
            parent_callback: çˆ¶çº§å›è°ƒå¯¹è±¡
        """
        self.config = config_manager
        self.adk = adk_manager
        self.parent_callback = parent_callback
        self.logger = get_logger("UnifiedWIMManager")
        
        # åˆå§‹åŒ–ä¸Šä¸‹æ–‡
        self.operation_context = {}
        update_log_context(
            module="UnifiedWIMManager",
            operation="initialization"
        )
        
        # åˆå§‹åŒ–å­æ¨¡å—
        self.path_manager = PathManager()
        self.check_manager = CheckManager(self.path_manager)
        self.operation_manager = OperationManager(
            self.path_manager, 
            self.check_manager, 
            self.config, 
            self.adk, 
            self.parent_callback
        )
        self.status_manager = StatusManager(self.path_manager)
        
        self.logger.info("ç»Ÿä¸€WIMç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ")
        self.logger.info("å­æ¨¡å—åˆå§‹åŒ–å®Œæˆ: PathManager, CheckManager, OperationManager, StatusManager")
    
    # === è·¯å¾„ç®¡ç†æ¥å£ ===
    def get_mount_dir(self, build_dir: Path) -> Path:
        """è·å–ç»Ÿä¸€çš„æŒ‚è½½ç›®å½•"""
        return self.path_manager.get_mount_dir(build_dir)
    
    def find_wim_files(self, build_dir: Path) -> list:
        """åœ¨æ„å»ºç›®å½•ä¸­æŸ¥æ‰¾æ‰€æœ‰WIMæ–‡ä»¶"""
        return self.path_manager.find_wim_files(build_dir)
    
    def get_primary_wim(self, build_dir: Path) -> Optional[Path]:
        """è·å–ä¸»è¦çš„WIMæ–‡ä»¶"""
        return self.path_manager.get_primary_wim(build_dir)
    
    # === æ£€æŸ¥æœºåˆ¶æ¥å£ ===
    def pre_mount_checks(self, build_dir: Path, wim_file_path: Path) -> Tuple[bool, str]:
        """æŒ‚è½½å‰å®Œæ•´æ£€æŸ¥"""
        return self.check_manager.pre_mount_checks(build_dir, wim_file_path)
    
    def pre_unmount_checks(self, build_dir: Path) -> Tuple[bool, str]:
        """å¸è½½å‰å®Œæ•´æ£€æŸ¥"""
        return self.check_manager.pre_unmount_checks(build_dir)
    
    def pre_iso_checks(self, build_dir: Path) -> Tuple[bool, str]:
        """ISOåˆ›å»ºå‰å®Œæ•´æ£€æŸ¥"""
        return self.check_manager.pre_iso_checks(build_dir, self.config)
    
    def pre_usb_checks(self, build_dir: Path, usb_path: Path) -> Tuple[bool, str]:
        """USBåˆ¶ä½œå‰å®Œæ•´æ£€æŸ¥"""
        return self.check_manager.pre_usb_checks(build_dir, usb_path)
    
    # === æ“ä½œæ¥å£ ===
    def mount_wim(self, build_dir: Path, wim_file_path: Path = None) -> Tuple[bool, str]:
        """ç»Ÿä¸€æŒ‚è½½æ¥å£"""
        return self.operation_manager.mount_wim(build_dir, wim_file_path)
    
    def unmount_wim(self, build_dir: Path, commit: bool = True) -> Tuple[bool, str]:
        """ç»Ÿä¸€å¸è½½æ¥å£"""
        return self.operation_manager.unmount_wim(build_dir, commit)
    
    def create_iso(self, build_dir: Path, iso_path: Path = None) -> Tuple[bool, str]:
        """ç»Ÿä¸€ISOåˆ›å»ºæ¥å£"""
        return self.operation_manager.create_iso(build_dir, iso_path)
    
    def create_usb(self, build_dir: Path, usb_path: Path) -> Tuple[bool, str]:
        """ç»Ÿä¸€USBåˆ¶ä½œæ¥å£"""
        return self.operation_manager.create_usb(build_dir, usb_path)
    
    def auto_unmount_before_iso(self, build_dir: Path) -> Tuple[bool, str]:
        """ISOåˆ›å»ºå‰è‡ªåŠ¨å¸è½½é•œåƒ"""
        return self.operation_manager.auto_unmount_before_iso(build_dir)
    
    # === çŠ¶æ€ç®¡ç†æ¥å£ ===
    def get_mount_status(self, build_dir: Path) -> Dict:
        """è·å–æŒ‚è½½çŠ¶æ€ä¿¡æ¯"""
        return self.status_manager.get_mount_status(build_dir)
    
    def get_build_info(self, build_dir: Path) -> Dict:
        """è·å–æ„å»ºç›®å½•å®Œæ•´ä¿¡æ¯"""
        return self.status_manager.get_build_info(build_dir)
    
    def get_wim_summary(self, build_dir: Path) -> Dict:
        """è·å–WIMæ–‡ä»¶æ‘˜è¦ä¿¡æ¯"""
        return self.status_manager.get_wim_summary(build_dir)
    
    def get_system_status(self) -> Dict:
        """è·å–ç³»ç»ŸçŠ¶æ€ä¿¡æ¯"""
        return self.status_manager.get_system_status()
    
    def validate_build_structure(self, build_dir: Path) -> Dict:
        """éªŒè¯æ„å»ºç›®å½•ç»“æ„"""
        return self.status_manager.validate_build_structure(build_dir)
    
    # === é«˜çº§åŠŸèƒ½æ¥å£ ===
    def quick_mount_check(self, build_dir: Path) -> Dict:
        """å¿«é€ŸæŒ‚è½½æ£€æŸ¥
        
        Args:
            build_dir: æ„å»ºç›®å½•è·¯å¾„
            
        Returns:
            Dict: å¿«é€Ÿæ£€æŸ¥ç»“æœ
        """
        try:
            self.logger.info("ğŸ” æ‰§è¡Œå¿«é€ŸæŒ‚è½½æ£€æŸ¥...")
            
            # è·å–ä¸»è¦WIMæ–‡ä»¶
            primary_wim = self.get_primary_wim(build_dir)
            
            # è·å–æŒ‚è½½çŠ¶æ€
            mount_status = self.get_mount_status(build_dir)
            
            # æ‰§è¡ŒåŸºæœ¬æ£€æŸ¥
            if primary_wim:
                mount_check, mount_msg = self.pre_mount_checks(build_dir, primary_wim)
            else:
                mount_check, mount_msg = False, "æœªæ‰¾åˆ°ä¸»è¦WIMæ–‡ä»¶"
            
            result = {
                "build_dir": str(build_dir),
                "primary_wim": str(primary_wim) if primary_wim else None,
                "mount_status": mount_status,
                "mount_check_passed": mount_check,
                "mount_check_message": mount_msg,
                "recommendations": []
            }
            
            # ç”Ÿæˆå»ºè®®
            if not primary_wim:
                result["recommendations"].append("å»ºè®®å…ˆåˆ›å»ºæˆ–å¤åˆ¶WIMæ–‡ä»¶åˆ°æ„å»ºç›®å½•")
            
            if mount_status["is_mounted"]:
                result["recommendations"].append("æ£€æµ‹åˆ°å·²æŒ‚è½½çš„é•œåƒï¼Œå»ºè®®å…ˆå¸è½½å†è¿›è¡Œå…¶ä»–æ“ä½œ")
            
            if not mount_check:
                result["recommendations"].append(f"æŒ‚è½½æ£€æŸ¥å¤±è´¥: {mount_msg}")
            
            return result
            
        except Exception as e:
            self.logger.error(f"å¿«é€ŸæŒ‚è½½æ£€æŸ¥å¤±è´¥: {str(e)}")
            return {"error": str(e)}
    
    def smart_cleanup(self, build_dir: Path) -> Dict:
        """æ™ºèƒ½æ¸…ç†æ„å»ºç›®å½•
        
        Args:
            build_dir: æ„å»ºç›®å½•è·¯å¾„
            
        Returns:
            Dict: æ¸…ç†ç»“æœ
        """
        try:
            self.logger.info("ğŸ§¹ æ‰§è¡Œæ™ºèƒ½æ¸…ç†...")
            
            cleanup_result = {
                "build_dir": str(build_dir),
                "actions_taken": [],
                "warnings": [],
                "success": True
            }
            
            # æ£€æŸ¥æŒ‚è½½çŠ¶æ€
            mount_status = self.get_mount_status(build_dir)
            
            if mount_status["is_mounted"]:
                # å°è¯•å¸è½½
                success, message = self.unmount_wim(build_dir, commit=False)
                if success:
                    cleanup_result["actions_taken"].append("æˆåŠŸå¸è½½WIMé•œåƒ")
                else:
                    cleanup_result["warnings"].append(f"å¸è½½å¤±è´¥: {message}")
                    cleanup_result["success"] = False
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            mount_dir = self.get_mount_dir(build_dir)
            if mount_dir.exists():
                try:
                    import shutil
                    shutil.rmtree(mount_dir, ignore_errors=True)
                    cleanup_result["actions_taken"].append("æ¸…ç†æŒ‚è½½ç›®å½•")
                except Exception as e:
                    cleanup_result["warnings"].append(f"æ¸…ç†æŒ‚è½½ç›®å½•å¤±è´¥: {str(e)}")
            
            # éªŒè¯æ¸…ç†ç»“æœ
            validation = self.validate_build_structure(build_dir)
            if not validation["is_valid"]:
                cleanup_result["warnings"].extend(validation["errors"])
            
            return cleanup_result
            
        except Exception as e:
            self.logger.error(f"æ™ºèƒ½æ¸…ç†å¤±è´¥: {str(e)}")
            return {"error": str(e), "success": False}
    
    def get_operation_history(self, build_dir: Path) -> Dict:
        """è·å–æ“ä½œå†å²ï¼ˆç®€åŒ–å®ç°ï¼‰
        
        Args:
            build_dir: æ„å»ºç›®å½•è·¯å¾„
            
        Returns:
            Dict: æ“ä½œå†å²ä¿¡æ¯
        """
        try:
            # è¿™é‡Œå¯ä»¥å®ç°æ›´å¤æ‚çš„æ“ä½œå†å²è®°å½•
            # ç›®å‰è¿”å›åŸºæœ¬çš„çŠ¶æ€ä¿¡æ¯
            build_info = self.get_build_info(build_dir)
            mount_status = self.get_mount_status(build_dir)
            
            return {
                "build_dir": str(build_dir),
                "current_status": {
                    "mounted": mount_status["is_mounted"],
                    "wim_count": len(build_info.get("wim_files", [])),
                    "last_modified": build_info.get("created_time")
                },
                "available_operations": self._get_available_operations(build_dir),
                "recommendations": self._get_operation_recommendations(build_dir)
            }
            
        except Exception as e:
            self.logger.error(f"è·å–æ“ä½œå†å²å¤±è´¥: {str(e)}")
            return {"error": str(e)}
    
    def _get_available_operations(self, build_dir: Path) -> list:
        """è·å–å¯ç”¨æ“ä½œåˆ—è¡¨"""
        operations = []
        
        try:
            mount_status = self.get_mount_status(build_dir)
            wim_files = self.find_wim_files(build_dir)
            
            if wim_files and not mount_status["is_mounted"]:
                operations.append("mount")
            
            if mount_status["is_mounted"]:
                operations.append("unmount")
                operations.append("modify")
            
            if not mount_status["is_mounted"] and wim_files:
                operations.append("create_iso")
                operations.append("create_usb")
            
            operations.append("cleanup")
            operations.append("validate")
            
        except Exception as e:
            self.logger.error(f"è·å–å¯ç”¨æ“ä½œå¤±è´¥: {str(e)}")
        
        return operations
    
    def _get_operation_recommendations(self, build_dir: Path) -> list:
        """è·å–æ“ä½œå»ºè®®"""
        recommendations = []
        
        try:
            mount_status = self.get_mount_status(build_dir)
            wim_files = self.find_wim_files(build_dir)
            validation = self.validate_build_structure(build_dir)
            
            if not wim_files:
                recommendations.append("å»ºè®®å…ˆåˆ›å»ºæˆ–å¤åˆ¶WIMæ–‡ä»¶")
            
            if mount_status["is_mounted"]:
                recommendations.append("å»ºè®®å®Œæˆä¿®æ”¹ååŠæ—¶å¸è½½é•œåƒ")
            
            if validation.get("warnings"):
                recommendations.extend(validation["warnings"])
            
            if not recommendations:
                recommendations.append("æ„å»ºç›®å½•çŠ¶æ€è‰¯å¥½ï¼Œå¯ä»¥è¿›è¡Œæ­£å¸¸æ“ä½œ")
            
        except Exception as e:
            self.logger.error(f"è·å–æ“ä½œå»ºè®®å¤±è´¥: {str(e)}")
        
        return recommendations
    
    # === è°ƒè¯•å’Œè¯Šæ–­æ¥å£ ===
    def get_diagnostics(self, build_dir: Path) -> Dict:
        """è·å–è¯Šæ–­ä¿¡æ¯
        
        Args:
            build_dir: æ„å»ºç›®å½•è·¯å¾„
            
        Returns:
            Dict: è¯Šæ–­ä¿¡æ¯
        """
        try:
            self.logger.info("ğŸ”§ æ”¶é›†è¯Šæ–­ä¿¡æ¯...")
            
            diagnostics = {
                "timestamp": self._get_current_timestamp(),
                "build_directory": str(build_dir),
                "system_info": self.get_system_status(),
                "build_info": self.get_build_info(build_dir),
                "mount_status": self.get_mount_status(build_dir),
                "validation": self.validate_build_structure(build_dir),
                "wim_summary": self.get_wim_summary(build_dir),
                "module_status": {
                    "path_manager": "ok",
                    "check_manager": "ok",
                    "operation_manager": "ok",
                    "status_manager": "ok"
                }
            }
            
            return diagnostics
            
        except Exception as e:
            self.logger.error(f"æ”¶é›†è¯Šæ–­ä¿¡æ¯å¤±è´¥: {str(e)}")
            return {"error": str(e)}
    
    def _get_current_timestamp(self) -> str:
        """è·å–å½“å‰æ—¶é—´æˆ³"""
        from datetime import datetime
        return datetime.now().isoformat()
